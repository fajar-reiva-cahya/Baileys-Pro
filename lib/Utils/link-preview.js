var __createBinding=this&&this.__createBinding||(Object.create?function(a,b,c,d){void 0===d&&(d=c);var e=Object.getOwnPropertyDescriptor(b,c);if(!e||("get"in e?!b.__esModule:e.writable||e.configurable))e={enumerable:!0,get:function(){return b[c]}};Object.defineProperty(a,d,e)}:function(a,b,c,d){void 0===d&&(d=c);a[d]=b[c]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(a,b){Object.defineProperty(a,"default",{enumerable:!0,value:b})}:function(a,b){a["default"]=b}),__importStar=
this&&this.__importStar||function(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)"default"!==c&&Object.prototype.hasOwnProperty.call(a,c)&&__createBinding(b,a,c);__setModuleDefault(b,a);return b};Object.defineProperty(exports,"__esModule",{value:!0});exports.getUrlInfo=void 0;
const messages_1=require("./messages"),messages_media_1=require("./messages-media"),THUMBNAIL_WIDTH_PX=192,getCompressedJpegThumbnail=async(a,{thumbnailWidth:b,fetchOpts:c})=>{a=await (0,messages_media_1.getHttpStream)(a,c);return await (0,messages_media_1.extractImageThumb)(a,b)},getUrlInfo=async(a,b={thumbnailWidth:THUMBNAIL_WIDTH_PX,fetchOpts:{timeout:3E3}})=>{var c;try{const {getLinkPreview:d}=await Promise.resolve().then(()=>__importStar(require("link-preview-js")));let e=a;a.startsWith("https://")||
a.startsWith("http://")||(e="https://"+e);const h=await d(e,{...b.fetchOpts,followRedirects:"follow",handleRedirects:(f,g)=>{f=new URL(f);g=new URL(g);return g.hostname===f.hostname||g.hostname==="www."+f.hostname||"www."+g.hostname===f.hostname?(1,!0):!1},headers:b.fetchOpts});if(h&&"title"in h&&h.title){const [f]=h.images,g={"canonical-url":h.url,"matched-text":a,title:h.title,description:h.description,originalThumbnailUrl:f};if(b.uploadImage){const {imageMessage:k}=await (0,messages_1.prepareWAMessageMedia)({image:{url:f}},
{upload:b.uploadImage,mediaTypeOverride:"thumbnail-link",options:b.fetchOpts});g.jpegThumbnail=(null===k||void 0===k?0:k.jpegThumbnail)?Buffer.from(k.jpegThumbnail):void 0;g.highQualityThumbnail=k||void 0}else try{g.jpegThumbnail=f?(await getCompressedJpegThumbnail(f,b)).buffer:void 0}catch(k){null===(c=b.logger)||void 0===c||c.debug({err:k.stack,url:e},"error in generating thumbnail")}return g}}catch(d){if(!d.message.includes("receive a valid"))throw d;}};exports.getUrlInfo=getUrlInfo;
