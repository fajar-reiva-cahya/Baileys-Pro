var __createBinding=this&&this.__createBinding||(Object.create?function(e,f,c,l){void 0===l&&(l=c);var b=Object.getOwnPropertyDescriptor(f,c);if(!b||("get"in b?!f.__esModule:b.writable||b.configurable))b={enumerable:!0,get:function(){return f[c]}};Object.defineProperty(e,l,b)}:function(e,f,c,l){void 0===l&&(l=c);e[l]=f[c]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,f){Object.defineProperty(e,"default",{enumerable:!0,value:f})}:function(e,f){e["default"]=f}),__importStar=
this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var f={};if(null!=e)for(var c in e)"default"!==c&&Object.prototype.hasOwnProperty.call(e,c)&&__createBinding(f,e,c);__setModuleDefault(f,e);return f};Object.defineProperty(exports,"__esModule",{value:!0});exports.encodeBinaryNode=void 0;const constants=__importStar(require("./constants")),jid_utils_1=require("./jid-utils"),encodeBinaryNode=(e,f=constants,c=[0])=>{e=encodeBinaryNodeInner(e,f,c);return Buffer.from(e)};
exports.encodeBinaryNode=encodeBinaryNode;
const encodeBinaryNodeInner=({tag:e,attrs:f,content:c},l,b)=>{const {TAGS:h,TOKEN_MAP:v}=l,w=(a,d,g=!1)=>{for(let k=0;k<d;k++)b.push(a>>8*(g?k:d-1-k)&255)},n=a=>{for(const d of a)b.push(d)},q=a=>{if(4294967296<=a)throw Error("string too large to encode: "+a);1048576<=a?(b.push(h.BINARY_32&255),w(a,4)):256<=a?(b.push(h.BINARY_20&255),n([a>>16&15,a>>8&255,a&255])):(b.push(h.BINARY_8&255),b.push(a&255))},x=({domainType:a,device:d,user:g,server:k})=>{"undefined"!==typeof d?(b.push(h.AD_JID&255),b.push((a||
0)&255),b.push((d||0)&255),m(g)):(b.push(h.JID_PAIR&255),g.length?m(g):b.push(h.LIST_EMPTY&255),m(k))},y=a=>{switch(a){case "-":return 10;case ".":return 11;case "\x00":return 15;default:if("0"<=a&&"9">=a)return a.charCodeAt(0)-48;throw Error(`invalid byte for nibble "${a}"`);}},z=a=>{if("0"<=a&&"9">=a)return a.charCodeAt(0)-48;if("A"<=a&&"F">=a)return 10+a.charCodeAt(0)-65;if("a"<=a&&"f">=a)return 10+a.charCodeAt(0)-97;if("\x00"===a)return 15;throw Error(`Invalid hex char "${a}"`);},r=(a,d)=>{if(a.length>
h.PACKED_MAX)throw Error("Too many bytes to pack");b.push(("nibble"===d?h.NIBBLE_8:h.HEX_8)&255);var g=Math.ceil(a.length/2);0!==a.length%2&&(g|=128);b.push(g&255);d="nibble"===d?y:z;g=Math.floor(a.length/2);for(let p=0;p<g;p++){var k=a[2*p+1];k=d(a[2*p])<<4|d(k);b.push(k&255)}0!==a.length%2&&(a=d(a[a.length-1])<<4|d("\x00"),b.push(a&255))},m=a=>{var d=v[a];if(d)"number"===typeof d.dict&&b.push(h.DICTIONARY_0+d.dict&255),b.push(d.index&255);else{a:if(a.length>h.PACKED_MAX)d=!1;else{for(const k of a)if(!("0"<=
k&&"9">=k)&&"-"!==k&&"."!==k){d=!1;break a}d=!0}if(d)r(a,"nibble");else{a:if(a.length>h.PACKED_MAX)var g=!1;else{for(g of a)if(!("0"<=g&&"9">=g||"A"<=g&&"F">=g)){g=!1;break a}g=!0}g?r(a,"hex"):a&&((g=(0,jid_utils_1.jidDecode)(a))?x(g):(a=Buffer.from(a,"utf-8"),q(a.length),n(a)))}}},t=a=>{0===a?b.push(h.LIST_EMPTY&255):256>a?n([h.LIST_8,a]):(b.push(h.LIST_16&255),n([a>>8&255,a&255]))},u=Object.keys(f).filter(a=>"undefined"!==typeof f[a]&&null!==f[a]);t(2*u.length+1+("undefined"!==typeof c?1:0));m(e);
for(const a of u)"string"===typeof f[a]&&(m(a),m(f[a]));if("string"===typeof c)m(c);else if(Buffer.isBuffer(c)||c instanceof Uint8Array)q(c.length),n(c);else if(Array.isArray(c)){t(c.length);for(const a of c)encodeBinaryNodeInner(a,l,b)}else if("undefined"!==typeof c)throw Error(`invalid children for header "${e}": ${c} (${typeof c})`);return b};
